
# $Id: Makefile.in,v 1.15 1999/11/05 01:00:28 jimg Exp $

@SET_MAKE@

PROG = readfile newform chkform bufform checkvar
FF_LIBRARY = libfreeform.a
MM_LIBRARY = libmaxmin.a

DODS_ROOT = ../../..

INCS = -I.
DEFS = @DEFS@
# Defines that the FreeForm library responds to. 4/16/98 jhrg
# -DDEBUG -DDLL_CHK -DDEBUG_MSG -DMEMTRACK=1 -DMEMTRACK_B -DFF_CHK_ADDR
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCS)
CFLAGS = @CFLAGS@ -Wall #-Wno-char-subscripts
TEST_COV_FLAGS = -ftest-coverage -fprofile-arcs
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
TAGS_FLAGS = 

# For these files, install only locally so as to not override any other
# version of FreeForm on this machine. 4/16/98 jhrg

prefix = .
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib
includedir = $(prefix)/include

SHELL = /bin/sh
srcdir = @srcdir@
dir = @dir@

# names of key programs

LN_S = @LN_S@
CP = cp
AWK = @AWK@
CC = @CC@
AR = ar
TAGS = etags
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
STRIP = strip
PURIFY = purify -chain-length="10" 

FF_OBJS = afm2bfm.o avlins.o avlfree.o cv_units.o dbevents.o dl_lists.o \
	  eqn_util.o error.o eval_eqn.o ff_utils.o file2buf.o formlist.o \
	  freeform.o makedbin.o makeform.o name_tab.o ndarray.o os_utils.o \
	  proclist.o setdbin.o showdbin.o  

MM_OBJS = mm_make.o 

PROG_OBJS = newform.o readfile.o chkform.o checkvar.o

FF_SRCS	= $(FF_OBJS:.o=.c)
PROG_SRCS = $(PROG_OBJS:.o=.c)
ALLSRCS = $(FF_SRCS)

LIBS = $(FF_LIBRARY) $(MM_LIBRARY)

all: $(LIBS) $(PROG)

$(FF_LIBRARY):	$(FF_OBJS) 
		$(AR) $(ARFLAGS) $(FF_LIBRARY) $(FF_OBJS)
		$(RANLIB) $(FF_LIBRARY)

$(MM_LIBRARY):	$(MM_OBJS) 
		$(AR) $(ARFLAGS) $(MM_LIBRARY) $(MM_OBJS)
		$(RANLIB) $(MM_LIBRARY)

newform: newform.o $(LIBS)
	$(CC) $(LDFLAGS) newform.o -o $@ $(LIBS) -lm

checkvar: checkvar.o $(LIBS)
	$(CC) $(LDFLAGS) checkvar.o -o $@ $(LIBS) -lm

newform-pure: newform.o $(LIBS)
	$(PURIFY) $(CC) $(LDFLAGS) newform.o -o $@ $(LIBS) -lm
	-rm newform.o

newform.o: newform.c
	$(CC) $(CPPFLAGS) -DFF_MAIN $(CFLAGS) -c $< -o $@

bufform: bufform.o $(LIBS)
	$(CC) $(LDFLAGS) bufform.o -o $@ $(LIBS) -lm

bufform-pure: bufform.o $(LIBS)
	$(PURIFY) $(CC) $(LDFLAGS) bufform.o -o $@ $(LIBS) -lm
	-rm bufform.o

bufform.o: bufform.c
	$(CC) $(CPPFLAGS) -DFF_MAIN $(CFLAGS) -c $< -o $@

readfile: readfile.o
	$(CC) $(LDFLAGS) readfile.o -o $@

chkform: chkform.o $(LIBS)
	$(CC) $(LDFLAGS) chkform.o -o $@ $(LIBS) -lm

chkform-pure: chkform.o $(LIBS)
	$(PURIFY) $(CC) $(LDFLAGS) chkform.o -o $@ $(LIBS) -lm
	-rm chkform.o

chkform.o: chkform.c
	$(CC) $(CPPFLAGS) -DFF_MAIN $(CFLAGS) -c $< -o $@

clean:
	-rm -f $(FF_OBJS) $(MM_OBJS) $(FF_LIBRARY) $(MM_LIBRARY) \
	newform newform.o core *~ readfile.o readfile chkform.o chkform \
	bufform bufform.o checkvar checkvar.o *.bb *.bbg *.da

distclean: clean
	-rm -f config.status config.log config.cache
	-(cd bin; rm newform readfile chkform)
	-(cd lib; rm lib*.a)
	-rm -f test-coverage/*

install: newform readfile chkform $(FF_LIBRARY)
	$(INSTALL_DATA) $(FF_LIBRARY) $(libdir)/$(FF_LIBRARY)
	$(RANLIB) $(libdir)/$(FF_LIBRARY)
	$(INSTALL_DATA) $(MM_LIBRARY) $(libdir)/$(MM_LIBRARY)
	$(RANLIB) $(libdir)/$(MM_LIBRARY)
	$(INSTALL_PROGRAM) newform $(bindir)/newform
	$(INSTALL_PROGRAM) readfile $(bindir)/readfile
	$(INSTALL_PROGRAM) chkform $(bindir)/chkform
	$(INSTALL_PROGRAM) readfile $(bindir)/readfile
	$(INSTALL_PROGRAM) checkvar $(bindir)/checkvar

Makefile: Makefile.in
	if [ -x ../config.status ]; \
	then \
	    ${SHELL} ../config.status; \
	else \
	    ../configure; \
	fi

check: newform readfile
	cd testsuite; test_newform

test-coverage: clean
	$(MAKE) $(MFLAGS) CFLAGS="$(CFLAGS) $(TEST_COV_FLAGS)" check

# Note that the gcov options -f and -b are useful but sometimes make looking
# at the results of coverage analysis a little taxing. -b reports on all
# branched and -f reports on all functions. The -l -o options summarize on a
# per-file basis. 3/27/98 jhrg
collect-coverage-data:
	(cd test-coverage; \
         cov_dat="coverage-data-`date +%m.%d.%y`"; \
	 touch $$cov_dat; \
	 for f in $(ALLSRCS); do \
	     echo "\n*** Coverage data for $$f ***\n" >> $$cov_dat; \
	     gcov -l -o ../ $$f >> $$cov_dat; \
         done)

tags:
	$(TAGS) $(TAGS_FLAGS) *.c *.h

.PHONY: depend
depend: 
	@depend@ -m Makefile.in -- $(CPPFLAGS) -- $(FF_SRCS) $(PROG_SRCS)

.SUFFIXES:      .o .c

.c.o:
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

# DO NOT DELETE; depend depends on this line.
