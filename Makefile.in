
# $Id: Makefile.in,v 1.10 1998/12/28 19:18:09 jimg Exp $

@SET_MAKE@

PROG = ff_das ff_dds ff_dods
FF_LIBS = libfreeform.a libmaxmin.a 
DODS_ROOT = ../..

WWW_ROOT = @WWW_ROOT@
INCS = -I. -I$(DODS_ROOT)/include -IFFND @INCS@
DEFS = @DEFS@ -DUSE_LIBGXX_INLINES
CPPFLAGS = @CPPFLAGS@ $(DEFS) $(INCS)
CXXFLAGS = @CXXFLAGS@ -Wall
CFLAGS = @CFLAGS@ -Wall

# Search in both the FFND and FFND/lib dirs for the freeform libraries.
LDFLAGS = @LDFLAGS@ -L. -L$(DODS_ROOT)/lib -LFFND -LFFND/lib
LFLAGS = -8
YFLAGS = -d -v
LIBS = -ldap++ -lfreeform -lmaxmin @LIBS@ -lm
TAGS_FLAGS = --include=../dap*/TAGS

# Set the instalation directories; prefix can be set on the command line
# during Makefile construction with `./configure --prefix /my/choice'

prefix = @prefix@
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
libdir = $(exec_prefix)/lib
includedir = $(prefix)/include
manext = 1
mandir = $(prefix)/man/man$(manext)

src = $(DODS_ROOT)/src
etcdir = $(DODS_ROOT)/etc

INSTALLMAN = man

SHELL = /bin/sh
srcdir = @srcdir@
version = @VERSION@
dir = ff-dods-@VERSION@

# names of key programs

LN_S = @LN_S@
CP = cp
AWK = @AWK@
CC = @CC@
CXX = @CXX@
YACC = @YACC@
LEX = @LEX@
AR = ar
TAGS = etags
RANLIB = @RANLIB@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
STRIP = strip

FFSRC = FFArray.cc FFByte.cc FFFloat64.cc FFFunction.cc \
	FFGrid.cc FFInt32.cc FFList.cc FFSequence.cc FFStr.cc \
	FFUInt32.cc FFStructure.cc FFUrl.cc util_ff.cc ff_read.c \
	ce_functions.cc date_proc.cc DODS_Date.cc ce_time_functions.cc \
	DODS_Time.cc DODS_Time_Factory.cc

FFOBJ =	FFArray.o FFByte.o FFFloat64.o FFFunction.o FFGrid.o \
	FFInt32.o FFList.o FFSequence.o FFStr.o FFStructure.o \
	FFUInt32.o FFUrl.o util_ff.o ff_read.o ce_functions.o date_proc.o \
	DODS_Date.o ce_time_functions.o DODS_Time.o DODS_Time_Factory.o

SERVSRC = ff_dods.cc ffdds.cc
SERVOBJ = ff_dods.o ffdds.o

DDSSRC = ff_dds.cc ffdds.cc
DDSOBJ = ff_dds.o ffdds.o

DASSRC = ffdas.cc ff_das.cc
DASOBJ = ffdas.o ff_das.o

all: $(FF_LIBS) ff_das ff_dds ff_dods

ff_das: $(DASOBJ) $(FFOBJ) 
	$(CXX) $(LDFLAGS) -o ff_das $(DASOBJ) $(FFOBJ) $(LIBS)

ff_dds: $(DDSOBJ) $(FFOBJ)
	$(CXX) $(LDFLAGS) -o ff_dds $(DDSOBJ) $(FFOBJ) $(LIBS)

ff_dods: $(SERVOBJ) $(FFOBJ)
	$(CXX) $(LDFLAGS) -o ff_dods $(SERVOBJ) $(FFOBJ) $(LIBS)

libfreeform.a: 
	cd FFND; $(MAKE) $(MFLAGS) $@

libmaxmin.a: 
	cd FFND; $(MAKE) $(MFLAGS) $@

check: test_read_ff

test_read_ff: ff_read.c libfreeform.a libmaxmin.a
	$(CC) -c -g -O0 $(CPPFLAGS) -DTEST -o ff_read.o ff_read.c
	$(CC) $(LDFLAGS) ff_read.o -o test_read_ff -lfreeform -liberty -lm \
	-lmaxmin

# Target to test the date code
tdate: DODS_Date.cc date_proc.cc
	$(CXX) -c -g -O0 -DTEST_DATE $(CPPFLAGS) DODS_Date.cc
	$(CXX) -c -g -O0 $(CPPFLAGS) date_proc.cc
	$(CXX) $(LDFLAGS) -o tdate DODS_Date.o date_proc.o

install: all
	$(INSTALL_PROGRAM) -s ff_das $(etcdir)
	$(INSTALL_PROGRAM) -s ff_dds $(etcdir)
	$(INSTALL_PROGRAM) -s ff_dods $(etcdir)
	$(INSTALL_PROGRAM) nph-ff $(etcdir)

Makefile: ${srcdir}/Makefile.in
	${SHELL} ./config.status

clean:
	-rm -f *.o *.sum *.log *~ core
	-rm -f $(PROG) test_read_ff
	-cd FFND && $(MAKE) $(MFLAGS) clean

distclean: clean
	-rm -f config.status config.log config.cache
	-cd FFND && $(MAKE) $(MFLAGS) distclean

.PHONY: tar
tar:
	-rm -f config.cache config.status config.log
	cd $(DODS_ROOT)/.. && \
	tar --exclude '*/old' --exclude '*/.#*' --exclude '*/CVS' \
	    --gzip --create --dereference --file DODS-$(dir).tar.gz \
	    DODS/src/$(dir)

.PHONY: update-version
update-version: check-version
	@echo "Version is: `cat version.h`"
	if [ ! -d ../$(dir) ]; then \
	    mv ../ff-dods* ../$(dir);\
	fi

# Compare the version encoded in this Makefile (set by configure) with the
# version in version.h. The version make variable is set up near the top of
# the Makefile.
.PHONY: check-version
check-version:
	@echo "Checking for version.h and Makefile version match-up"
	@if [ "$(version)" != "`cat version.h`" ]; \
	then \
		echo "You must manually re-run configure!"; \
		exit 1; \
	else \
		echo "Yes, they match."; \
	fi

.PHONY: depend
depend: 
	@depend@ -m dependencies \
	-- $(CPPFLAGS) -I/usr/local/lib/g++-include -- \
	$(FFSRC) $(SERVSRC)

.PHONY: tags
tags:
	$(TAGS) $(TAGS_FLAGS) *.cc *.h *.c

.SUFFIXES:      .o .cc .c

.c.o:
	$(CC) -c $(CFLAGS) $(CPPFLAGS) -o $@ $<

.cc.o:
	$(CXX) -c $(CXXFLAGS) $(CPPFLAGS) -o $@ $<

include dependencies



